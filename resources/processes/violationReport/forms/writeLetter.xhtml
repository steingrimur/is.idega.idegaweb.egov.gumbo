<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:idega="http://idega.com/xforms"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <!-- 
    
    WARNING
    
    this form is implemented together with the javascript file - writeLetter.js as a workaround for chiba bugs
    writeLetter.js fetches fbc_6 items by the selection of fbc_7 items.
    
    Thus make sure you change corresponding id's in the javascript if you change them in the xform.
    
    WARNING 
    
     -->
    <head>
        <title>
            <xf:output
                idega:ref="instance('localized_strings')/form-title[@lang=instance('localized_strings')/current_language]"
                model="data_model" ref="instance('localized_strings')/empty"/>
        </title>
        <script
            src="/idegaweb/bundles/is.idega.idegaweb.egov.gumbo.bundle/resources/javascript/writeLetter.js" type="text/javascript"/>
        <xf:model id="submission_model" schema="#fb-schema">
            <xf:instance id="data-instance" xmlns="">
                <data>
                    <form_id>231608</form_id>
                    <Letter_text_fbc_5 mapping="string_letterText"/>
                    <LetterSubject mapping="string_letterSubject"/>
                    <Choose_letter_template_fbc_6
                        mapping="string_letterType" xsi:nil="true"/>
                    <Choose_letter_template_type_fbc_7
                        mapping="string_letterTemplateType" xsi:nil="true"/>
                    <recipientSocialNr_fbc_8 mapping="string_recipientSocialNr"/>
                    <personData>
                        <name mapping="string_recipientName"/>
                        <address mapping="string_recipientAddress"/>
                        <postalCode mapping="string_recipientPostalCode"/>
                    </personData>
                    <writeLetterSubmitterName_fbc_13 mapping="string_writeLetterSubmitterName"/>
                    <pdfViewContainer/>
                    <letterDate mapping="string_letterDate"/>
                    <pdfText/>
                    <pdfTextTemplate11>
                    &lt;div style="width:680px;"&gt;
                    &lt;div style="float: left"&gt;
                    </pdfTextTemplate11>
                    <!--  recipient name -->
                    <pdfTextTemplate12>
                    &lt;br&gt;
                    </pdfTextTemplate12>
                    <!--  address -->
                    <pdfTextTemplate13>
                    &lt;br&gt;
                    </pdfTextTemplate13>
                    <!--  postal code -->
                    <pdfTextTemplate14>
                    &lt;/div&gt; 
                    &lt;img style="float: right;" src="http://www.fiskistofa.is/img/logofisk-2009.gif" /&gt;
                    </pdfTextTemplate14>
                    <pdfTextTemplate21>
                    &lt;p style="clear: left; padding-top: 50px;"&gt;
                    &lt;b&gt;Efni:&lt;/b&gt;
                    </pdfTextTemplate21>
                    <!-- letter subject name -->
                    <pdfTextTemplate22>
                    &lt;div style="float:right;"&gt;
                    </pdfTextTemplate22>
                    <!-- letter date -->
                    <pdfTextTemplate23>
                    &lt;/div&gt;
                    &lt;/p&gt;
                    </pdfTextTemplate23>
                    <pdfTextTemplate31>
                    &lt;div style="padding-top: 30px;"&gt;
                    </pdfTextTemplate31>
                    <!-- letter text -->
                    <pdfTextTemplate32>
                    &lt;/div&gt;
                    &lt;p style="text-align: center; padding-top: 50px;"&gt;
                    Fyrir h√∂nd Fiskistofu,
                    &lt;/p&gt;
                    
                    &lt;p style="text-align: center; padding-top: 50px;"&gt;
                    </pdfTextTemplate32>
                    <!-- submitter name -->
                    <pdfTextTemplate33>
                    
                    &lt;/p&gt;
                    &lt;/div&gt;
                    </pdfTextTemplate33>
                </data>
            </xf:instance>
            <xf:instance id="control-instance">
                <control xmlns="">
                    <required>true</required>
                    <readonly>false</readonly>
                    <submission>false</submission>
                    <generatePdf>false</generatePdf>
                    <submissionButton/>
                </control>
            </xf:instance>
            <xf:bind id="errorsGroup" idega:shared="true"
                nodeset="instance('error-instance')/error" relevant="instance('control-instance')/submission = 'true' and count-non-empty(instance('error-instance')/error)!=0"/>
            <xf:bind id="errors" idega:shared="true" nodeset="instance('error-instance')/error[. != '']"/>
            <xf:instance id="error-instance" xmlns="">
                <data>
                    <error for=""/>
                </data>
            </xf:instance>
            <xf:submission action="xformsBPM:/nouri"
                id="submit_data_submission" method="post"
                ref="instance('data-instance')" replace="none">
                <idega:toggle case="fbc_4" ev:event="xforms-submit-done"/>
            </xf:submission>
            <xf:action ev:event="xforms-submit-error" id="submission-error">
                <xf:dispatch name="idega-submit-error" target="idega-submission-error"/>
            </xf:action>
            <xf:action ev:event="idega-submit-error" id="idega-submission-error">
                <xf:message level="modeless" ref="instance('localized_strings')/submission-error_message[@lang=instance('localized_strings')/current_language]"/>
            </xf:action>
            <xf:bind id="bind-submissionButton" idega:shared="true"
                nodeset="instance('control-instance')/submissionButton" relevant="instance('control-instance')/readonly != 'true' and instance('control-instance')/generatePdf != 'true'"/>
            <xf:bind
                calculate="if(instance('control-instance')/readonly = 'true' or instance('control-instance')/generatePdf = 'true', concat(instance('data-instance')/pdfTextTemplate11, instance('data-instance')/personData/name, instance('data-instance')/pdfTextTemplate12, instance('data-instance')/personData/address, instance('data-instance')/pdfTextTemplate13, instance('data-instance')/personData/postalCode, instance('data-instance')/pdfTextTemplate14, instance('data-instance')/pdfTextTemplate21, instance('data-instance')/LetterSubject, instance('data-instance')/pdfTextTemplate22, instance('data-instance')/letterDate, instance('data-instance')/pdfTextTemplate23, instance('data-instance')/pdfTextTemplate31, instance('data-instance')/Letter_text_fbc_5, instance('data-instance')/pdfTextTemplate32, instance('data-instance')/writeLetterSubmitterName_fbc_13, instance('data-instance')/pdfTextTemplate33), '')"
                id="fbc_15_bind" nodeset="pdfText" type="string"/>
            <xf:bind id="fbc_5_bind" nodeset="Letter_text_fbc_5"
                readonly="instance('control-instance')/readonly = 'true'"
                relevant="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'"
                required="instance('control-instance')/generatePdf != 'true'" type="string"/>
            <xf:bind id="fbc_5a_bind" nodeset="LetterSubject"
                readonly="instance('control-instance')/readonly = 'true'"
                relevant="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'"
                required="instance('control-instance')/generatePdf != 'true'" type="string"/>
            <xf:bind id="fbc_6_bind"
                nodeset="Choose_letter_template_fbc_6"
                readonly="instance('control-instance')/readonly = 'true'"
                relevant="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'"
                required="instance('control-instance')/required = 'true'" type="xs:string"/>
            <xf:bind id="fbc_7_bind"
                nodeset="Choose_letter_template_type_fbc_7"
                readonly="instance('control-instance')/readonly = 'true'"
                relevant="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'" type="xs:string"/>
            <xf:bind id="fbc_8_bind" nodeset="recipientSocialNr_fbc_8"
                readonly="instance('control-instance')/readonly = 'true'"
                relevant="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'"
                required="instance('control-instance')/generatePdf != 'true'" type="xs:string"/>
            <xf:bind id="fbc_9_bind" nodeset="personData/name"
                readonly="instance('control-instance')/readonly = 'true'"
                relevant="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'" type="xs:string"/>
            <xf:bind id="fbc_10_bind" nodeset="personData/address"
                readonly="instance('control-instance')/readonly = 'true'"
                relevant="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'" type="xs:string"/>
            <xf:bind id="fbc_11_bind" nodeset="personData/postalCode"
                readonly="instance('control-instance')/readonly = 'true'"
                relevant="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'" type="xs:string"/>
            <xf:bind id="fbc_13_bind"
                nodeset="writeLetterSubmitterName_fbc_13" type="xs:string"/>
            <xf:bind id="fbc_14_bind" nodeset="pdfViewContainer" relevant="instance('control-instance')/generatePdf = 'true' or instance('control-instance')/readonly = 'true'"/>
            <xf:instance id="fbc_13_autofill-instance"
                relevant="false()" src="context:fb-afk-loginSession.user.name"/>
        </xf:model>
        <xf:model id="data_model">
            <xf:instance id="localized_strings" xmlns="">
                <localized_strings>
                    <default_language>en</default_language>
                    <current_language>is_IS</current_language>
                    <submission-error_message lang="en">Submission error. Please check your form!</submission-error_message>
                    <submission-error_message lang="is_IS">Villa var√∞ vi√∞ a√∞ senda formi√∞, vinsamlegast athugi√∞ hvort stj√∂rnumerktir reitir hafi allir veri√∞ √∫tfylltir og a√∞ engar villur s√©u √≠ forminu.</submission-error_message>
                    <empty/>
                    <form-title lang="en">Write letter</form-title>
                    <form-title lang="is_IS">Skrifa br√©f</form-title>
                    <page-2-label lang="en">Submitted</page-2-label>
                    <page-2-label lang="is_IS">Skilabo√∞ send</page-2-label>
                    <page-1-submit-label lang="en">Submit</page-1-submit-label>
                    <page-1-submit-label lang="is_IS">Senda</page-1-submit-label>
                    <page-2-info lang="en">Form submitted, thank You!</page-2-info>
                    <page-2-info lang="is_IS">Br√©fi√∞ hefur veri√∞ b√∫i√∞ til og er a√∞gengilegt √≠ m√°laskr√°nni undir skj√∂lum m√°lsins</page-2-info>
                    <fbc_5a-label lang="is_IS">Efni</fbc_5a-label>
                    <fbc_5a-label lang="en">Subject</fbc_5a-label>
                    <fbc_5a-required lang="en">can not be empty</fbc_5a-required>
                    <fbc_5a-required lang="is_IS">Skilabo√∞ mega ekki vera t√≥m</fbc_5a-required>
                    <fbc_5-title lang="is_IS">Texti</fbc_5-title>
                    <fbc_5-title lang="en">Letter text</fbc_5-title>
                    <fbc_5-required lang="en">can not be empty</fbc_5-required>
                    <fbc_5-required lang="is_IS">Skilabo√∞ mega ekki vera t√≥m</fbc_5-required>
                    <fbc_6-label lang="is_IS">Br√©fst√≠lsni√∞</fbc_6-label>
                    <fbc_6-label lang="en">Choose letter template</fbc_6-label>
                    <fbc_7-label lang="is_IS">Tegund br√©fs</fbc_7-label>
                    <fbc_7-label lang="en">Choose letter template type</fbc_7-label>
                    <fbc_8-label lang="is_IS">Kennitala</fbc_8-label>
                    <fbc_8-label lang="en">Social security nr.</fbc_8-label>
                    <fbc_8-required lang="en">can not be empty</fbc_8-required>
                    <fbc_8-required lang="is_IS">Skilabo√∞ mega ekki vera t√≥m</fbc_8-required>
                    <fbc_9-label lang="is_IS">Nafn</fbc_9-label>
                    <fbc_9-label lang="en">Name</fbc_9-label>
                    <fbc_10-label lang="is_IS">Heimilisfang</fbc_10-label>
                    <fbc_10-label lang="en">Address</fbc_10-label>
                    <fbc_11-label lang="is_IS">P√≥stn√∫mer</fbc_11-label>
                    <fbc_11-label lang="en">Post code</fbc_11-label>
                    <fbc_16-pdf-label lang="is_IS">S√¶kja sem PDF</fbc_16-pdf-label>
                    <fbc_16-pdf-label lang="en">Get as PDF</fbc_16-pdf-label>
                </localized_strings>
            </xf:instance>
            <xf:instance id="locale-instance" relevant="false()" src="context:fb-afk-loginSession.currentLocale"/>
            <xf:action ev:event="xforms-ready">
                <xf:setvalue model="data_model"
                    ref="instance('localized_strings')/current_language" value="instance('locale-instance')/fb-afk-loginSession.currentLocale"/>
                <idega:dispatch name="idega-xforms-ready" target="//h:body//*[starts-with(@id, 'fbc_')]"/>
                <idega:setvalue
                    ref="instance('fbc_7_lds')/localizedEntries[@lang=instance('localized_strings')/current_language]/item" value="idega:resolveExpression('violationService.getLettersTypes()')"/>
                <xf:setvalue bind="fbc_13_bind"
                    id="fbc_13-autofill-setvalue"
                    model="submission_model" value="instance('fbc_13_autofill-instance')/fb-afk-loginSession.user.name"/>
                <xf:setvalue
                    if="instance('control-instance')/generatePdf!='true' and instance('control-instance')/readonly!='true'"
                    model="submission_model"
                    ref="instance('data-instance')/letterDate" value="concat(substring(now(),9,2), '.', substring(now(),6,2), '.', substring(now(),1,4))"/>
            </xf:action>
            <xf:instance id="fbc_6_lds" xmlns="">
                <local_src>
                    <localizedEntries lang="en">
                        <item/>
                    </localizedEntries>
                    <localizedEntries lang="is_IS">
                        <item/>
                    </localizedEntries>
                </local_src>
            </xf:instance>
            <xf:instance id="fbc_7_lds" xmlns="">
                <local_src>
                    <localizedEntries lang="en">
                        <item/>
                    </localizedEntries>
                    <localizedEntries lang="is_IS">
                        <item/>
                    </localizedEntries>
                </local_src>
            </xf:instance>
            <xf:instance id="fbc_6_eds" xmlns="">
                <ext_src/>
            </xf:instance>
        </xf:model>
        <xs:schema id="fb-schema"/>
    </head>
    <body>
        <xf:group appearance="full">
            <xf:group bind="errorsGroup" class="xformErrors">
                <xf:repeat bind="errors">
                    <xf:output ref="."/>
                </xf:repeat>
            </xf:group>
            <idega:setError ev:event="idega-validation-error"
                id="formSetErrorHandler" ref="instance('error-instance')/error"/>
            <idega:switch>
                <idega:case id="fbc_1" show="instance('control-instance')/generatePdf='true'">
                    <xf:group appearance="full">
                        <xf:input bind="fbc_8_bind" id="fbc_8" type="fbc_text">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_8-label[@lang=instance('localized_strings')/current_language]"/>
                            <xf:dispatch ev:event="idega-xforms-ready"
                                name="idega-validate" target="fbc_8"/>
                            <xf:dispatch ev:event="xforms-value-changed"
                                name="idega-validate" target="fbc_8"/>
                            <idega:validator ev:event="idega-validate">
                                <idega:message errorType="required"
                                    model="data_model" value="instance('localized_strings')/fbc_8-required[@lang=instance('localized_strings')/current_language]"/>
                            </idega:validator>
                            <xf:alert ref="instance('error-instance')/error[@for='fbc_8']"/>
                            <idega:setvalue
                                ev:event="xforms-value-changed"
                                multiple="true()"
                                placeResponseDocument="true()"
                                ref="instance('data-instance')/personData" value="idega:resolveBeanProperties('violationService.getRecipientPersonDataForWriteLetter({0})', '#{instance(`data-instance`)/recipientSocialNr_fbc_8}')"/>
                        </xf:input>
                        <xf:output bind="fbc_9_bind" id="fbc_9" type="fbc_text_output">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_9-label[@lang=instance('localized_strings')/current_language]"/>
                        </xf:output>
                        <xf:output bind="fbc_10_bind" id="fbc_10" type="fbc_text_output">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_10-label[@lang=instance('localized_strings')/current_language]"/>
                        </xf:output>
                        <xf:output bind="fbc_11_bind" id="fbc_11" type="fbc_text_output">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_11-label[@lang=instance('localized_strings')/current_language]"/>
                        </xf:output>
                        <xf:select1 appearance="minimal"
                            bind="fbc_7_bind" id="fbc_7" type="fbc_single_select_minimal">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_7-label[@lang=instance('localized_strings')/current_language]"/>
                            <xf:itemset model="data_model" nodeset="instance('fbc_7_lds')/localizedEntries[@lang=instance('localized_strings')/current_language]/item">
                                <xf:label ref="itemLabel"/>
                                <xf:value ref="itemValue"/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:select1 appearance="minimal"
                            bind="fbc_6_bind" id="fbc_6" type="fbc_single_select_minimal">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_6-label[@lang=instance('localized_strings')/current_language]"/>
                            <xf:itemset model="data_model" nodeset="instance('fbc_6_lds')/localizedEntries[@lang=instance('localized_strings')/current_language]/item">
                                <xf:label ref="itemLabel"/>
                                <xf:value ref="itemValue"/>
                            </xf:itemset>
                        </xf:select1>
                        <xf:input bind="fbc_5a_bind" id="fbc_4a">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_5a-label[@lang=instance('localized_strings')/current_language]"/>
                            <xf:dispatch ev:event="idega-xforms-ready"
                                name="idega-validate" target="fbc_4a"/>
                            <xf:dispatch ev:event="xforms-value-changed"
                                name="idega-validate" target="fbc_4a"/>
                            <idega:validator ev:event="idega-validate">
                                <idega:message errorType="required"
                                    model="data_model" value="instance('localized_strings')/fbc_5a-required[@lang=instance('localized_strings')/current_language]"/>
                            </idega:validator>
                            <xf:alert ref="instance('error-instance')/error[@for='fbc_4a']"/>
                        </xf:input>
                        <!-- class="enableHTMLEditor" -->
                        <xf:textarea bind="fbc_5_bind"
                            class="enableHTMLEditor enableHTMLEditor" id="fbc_5">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_5-title[@lang=instance('localized_strings')/current_language]"/>
                            <xf:dispatch ev:event="idega-xforms-ready"
                                name="idega-validate" target="fbc_5"/>
                            <xf:dispatch ev:event="xforms-value-changed"
                                name="idega-validate" target="fbc_5"/>
                            <idega:validator ev:event="idega-validate">
                                <idega:message errorType="required"
                                    model="data_model" value="instance('localized_strings')/fbc_5-required[@lang=instance('localized_strings')/current_language]"/>
                            </idega:validator>
                            <xf:alert ref="instance('error-instance')/error[@for='fbc_5']"/>
                        </xf:textarea>
                        <div class="fbc_button_area" id="fbc_2" type="fbc_button_area">
                            <xf:trigger bind="bind-submissionButton"
                                class="fbc_button_submit" id="fbc_3" type="fbc_button_submit">
                                <xf:label model="data_model" ref="instance('localized_strings')/page-1-submit-label[@lang=instance('localized_strings')/current_language]"/>
                                <xf:action ev:event="DOMActivate">
                                    <xf:setvalue
                                    ref="instance('control-instance')/submission" value="'true'"/>
                                    <idega:dispatch
                                    name="idega-validate" target="//h:body//*[starts-with(@id, 'fbc_')]"/>
                                    <xf:dispatch name="xforms-rebuild" target="data_model"/>
                                    <xf:dispatch
                                    name="xforms-recalculate" target="data_model"/>
                                    <xf:dispatch
                                    name="xforms-revalidate" target="data_model"/>
                                    <xf:dispatch name="xforms-refresh" target="data_model"/>
                                    <xf:action if="count-non-empty(instance('error-instance')/error)=0">
                                    <xf:send submission="submit_data_submission"/>
                                    </xf:action>
                                    <xf:dispatch
                                    if="count-non-empty(instance('error-instance')/error)!=0"
                                    name="idega-submit-error" target="idega-submission-error"/>
                                </xf:action>
                            </xf:trigger>
                        </div>
                        <xf:group appearance="full" bind="fbc_14_bind">
                            <div class="fbc_letterContent">
                                <xf:output bind="fbc_15_bind"
                                    id="fbc_15" mediatype="text/html" type="fbc_text_output"/>
                            </div>
                        </xf:group>
                    </xf:group>
                </idega:case>
                <idega:case id="fbc_4" type="thx_page">
                    <xf:group appearance="full">
                        <xf:label model="data_model" ref="instance('localized_strings')/page-2-label[@lang=instance('localized_strings')/current_language]"/>
                        <xf:output model="data_model" ref="instance('localized_strings')/page-2-info[@lang=instance('localized_strings')/current_language]"/>
                    </xf:group>
                </idega:case>
            </idega:switch>
        </xf:group>
    </body>
</html>