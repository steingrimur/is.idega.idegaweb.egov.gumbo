<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:idega="http://idega.com/xforms"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <head>
        <title>
            <xf:output model="data_model" ref="instance('localized_strings')/form-title[@lang=instance('localized_strings')/current_language]"/>
        </title>
        
        <script type="text/javascript" src="/idegaweb/bundles/is.idega.idegaweb.egov.gumbo.bundle/resources/javascript/aquacultureReport.js"></script>
        
        <xf:model id="submission_model" schema="#fb-schema">
            <xf:instance id="data-instance" xmlns="">
                <data>
                    <form_id>7166</form_id>
                    <saveFormData>
                        <submissionId/>
                    </saveFormData>
                    
                    <companyData>
                        <socialSecurityNr mapping="string_companySocialNumber"/>
                        <name mapping="string_companyName"/>
                        <address mapping="string_companyAddress"/>
                    </companyData>
                    
                    <reportForTheYear mapping="string_reportForTheYear"/>
                    <reportForTheFarm mapping="string_reportForTheFarm"/>
                    
                    <farmStructure mapping="objlist_farmStructure">
                        <list>
                            <row>
                                <speciesGroup/>
                                <items>
                                    <item value="x1">x lbl en</item>
                                                                    <!--
			                        <item >
 
			                            <itemLabel>x lbl en</itemLabel>
			                            <itemValue>x1</itemValue>
			                             
			                        </item>
			                        -->
                                </items>
                                <aquamethod/>
                                <aquaEnvironment/>                                
                                <size xsi:type="xsd:float" xsi:nil="true"/>
                                <unit/>
                            </row>
                            <row>
                                <speciesGroup/>
                                <items>
                                    <item value="x1">x lbl en</item>
                                                                    <!--
                                    <item >
 
                                        <itemLabel>x lbl en</itemLabel>
                                        <itemValue>x1</itemValue>
                                         
                                    </item>
                                    -->
                                </items>
                                <aquamethod/>
                                <aquaEnvironment/>                                
                                <size xsi:type="xsd:float" xsi:nil="true"/>
                                <unit/>
                            </row>
                        </list>
                        <trigger/>
                    </farmStructure>
                    
                </data>
            </xf:instance>
            <xf:instance id="control-instance">
                <control xmlns="">
                    <required>true</required>
                    <readonly>false</readonly>
                    <submission>false</submission>
                    <generatePdf>false</generatePdf>
                    <sendLinkSubmission>false</sendLinkSubmission>
                    <submissionButton/>
                </control>
            </xf:instance>
            <xf:instance id="error-instance" xmlns="">
                <data>
                    <error for=""/>
                    <sendLinkError for=""/>
                </data>
            </xf:instance>
            <xf:instance id="saveForm-instance">
                <data xmlns="">
                    <link/>
                    <savePhase>false</savePhase>
                </data>
            </xf:instance>
            <xf:instance id="downloadFormAsPDF-instance">
                <data xmlns="">
                    <link/>
                </data>
            </xf:instance>
            <xf:bind id="errorsGroup" idega:shared="true"
                nodeset="instance('error-instance')/error" relevant="instance('control-instance')/submission = 'true' and count-non-empty(instance('error-instance')/error)!=0"/>
            <xf:bind id="errors" idega:shared="true" nodeset="instance('error-instance')/error[. != '']"/>
            <xf:bind id="bind-submissionButton" idega:shared="true"
                nodeset="instance('control-instance')/submissionButton" relevant="instance('control-instance')/readonly != 'true' and instance('control-instance')/generatePdf != 'true'"/>
                
            <xf:bind id="fbc_5_bind"
                nodeset="companyData/socialSecurityNr" readonly="instance('control-instance')/readonly = 'true'" type="xs:string"/>
            <xf:bind id="fbc_6_bind"
                nodeset="companyData/name" readonly="instance('control-instance')/readonly = 'true'" type="xs:string"/>
            <xf:bind id="fbc_7_bind"
                nodeset="companyData/address" readonly="instance('control-instance')/readonly = 'true'" type="xs:string"/>
            <xf:bind id="fbc_8_bind"
                nodeset="reportForTheYear" readonly="instance('control-instance')/readonly = 'true'" type="xs:string"/>
                
            <xf:bind id="fbc_9_bind"
                nodeset="reportForTheFarm" 
                readonly="instance('control-instance')/readonly = 'true'"
                required="instance('control-instance')/required = 'true'"
                type="xs:string"/>
                
            <xf:bind id="fbc_10_bind"
                nodeset="farmStructure/list/row[position() != last()]" readonly="instance('control-instance')/readonly = 'true'">
                
                <xf:bind id="fbc_10_bind_2"
                nodeset="./speciesGroup">
	                <xf:bind id="fbc_10_bind_3"
	                nodeset="../items" />
                
                </xf:bind>
                
            </xf:bind>
            <xf:bind id="fbc_10_trigger" nodeset="farmStructure/trigger" relevant="instance('control-instance')/readonly != 'true' and instance('control-instance')/generatePdf != 'true'"/>
                
            <xf:submission action="xformsBPM:/nouri"
                id="submit_data_submission" method="post"
                ref="instance('data-instance')" replace="none">
                <idega:toggle case="fbc_4" ev:event="xforms-submit-done"/>
            </xf:submission>
            
            <xf:action ev:event="xforms-submit-error" id="submission-error">
                <xf:dispatch name="idega-submit-error" target="idega-submission-error"/>
            </xf:action>
            <xf:action ev:event="idega-submit-error" id="idega-submission-error">
                <xf:message level="modeless" ref="instance('localized_strings')/submission-error_message[@lang=instance('localized_strings')/current_language]"/>
            </xf:action>
            <xf:instance id="fbc_13_lds" xmlns="">
                <local_src>
                    <localizedEntries lang="en">
                        <item>
                            <itemLabel>x lbl en</itemLabel>
                            <itemValue>x1</itemValue>
                        </item>
                    </localizedEntries>
                    <localizedEntries lang="is_IS">
                        <item>
                            <itemLabel>x lbl is</itemLabel>
                            <itemValue>x1</itemValue>
                        </item>
                    </localizedEntries>
                </local_src>
            </xf:instance>
        </xf:model>
        <xf:model id="data_model">
            <xf:instance id="localized_strings" xmlns="">
                <localized_strings>
                    <default_language>en</default_language>
                    <current_language>en</current_language>
                    <form-title lang="en">Aquaculture report</form-title>
                    <form-title lang="is_IS">Aquaculture report</form-title>
                    <page-2-label lang="en">Form submitted</page-2-label>
                    <page-2-label lang="is_IS">Form sent</page-2-label>
                    <page-1-submit_button-label lang="en">Submit</page-1-submit_button-label>
                    <page-1-submit_button-label lang="is_IS">Senda</page-1-submit_button-label>
                    <submission-error_message lang="en">Submission error. Please check your form!</submission-error_message>
                    <submission-error_message lang="is_IS">Villa varð við að senda formið vinsamlegast athugið hvort stjörnumerktir reitir hafi allir verið útfylltir og að engar villur séu í forminu.</submission-error_message>
                    <submission-success_message lang="en">Your form has been received. Thank you.</submission-success_message>
                    <submission-success_message lang="is_IS">Formið hefur verið móttekið. Takk fyrir.</submission-success_message>
                    
                    <fbc_5-label lang="is_IS">Kennitala</fbc_5-label>
                    <fbc_5-label lang="en">Social security number</fbc_5-label>
                    <fbc_6-label lang="is_IS">Nafn</fbc_6-label>
                    <fbc_6-label lang="en">Name</fbc_6-label>
                    <fbc_7-label lang="is_IS">Heimilisfang</fbc_7-label>
                    <fbc_7-label lang="en">Address</fbc_7-label>
                    <fbc_8-label lang="is_IS">Report for the year</fbc_8-label>
                    <fbc_8-label lang="en">Report for the year</fbc_8-label>
                    <fbc_9-label lang="is_IS">Farm</fbc_9-label>
                    <fbc_9-label lang="en">Farm</fbc_9-label>
                    <fbc_9-required lang="is_IS">Það þarf að fylla út reitinn X</fbc_9-required>
                    <fbc_9-required lang="en">The field X is required</fbc_9-required>
                    
                    <fbc_10-label lang="is_IS">Farm structure</fbc_10-label>
                    <fbc_10-label lang="en">Farm structure</fbc_10-label>
                    <fbc_10-table-count-error lang="en">Bad number format. Check again.</fbc_10-table-count-error>
                    <fbc_10-table-count-error lang="is_IS">Tölurnar eru ekki rétt slegnar inn, lagfærðu og reyndu aftur.</fbc_10-table-count-error>
                    <fbc_10-insert-label lang="en">Insert</fbc_10-insert-label>
                    <fbc_10-insert-label lang="is_IS">Bæta við röð</fbc_10-insert-label>
                    <fbc_10-delete-label lang="en">Delete</fbc_10-delete-label>
                    <fbc_10-delete-label lang="is_IS">Eyða röð</fbc_10-delete-label>
                    <fbc_10-col1-label lang="en">Species group</fbc_10-col1-label>
                    <fbc_10-col1-label lang="is_IS">Species group</fbc_10-col1-label>
                    <fbc_10-col4-label lang="en">Size</fbc_10-col4-label>
                    <fbc_10-col4-label lang="is_IS">Size</fbc_10-col4-label>
                </localized_strings>
            </xf:instance>
            <xf:instance id="locale-instance" relevant="false()" src="context:fb-afk-loginSession.currentLocale"/>
            <xf:action ev:event="xforms-ready">
                <idega:dispatch name="idega-xforms-ready" target="//h:body//*[starts-with(@id, 'fbc_')]"/>
                <xf:setvalue model="data_model"
                    ref="instance('localized_strings')/current_language" value="instance('locale-instance')/fb-afk-loginSession.currentLocale"/>
                <xf:setvalue
                    if="instance('control-instance')/generatePdf='true'"
                    model="submission_model"
                    ref="instance('control-instance')/required" value="'false'"/>
                    
                    <xf:action if="instance('control-instance')/generatePdf != 'true' and instance('control-instance')/readonly != 'true'">
                    
                        <idega:setvalue
                                    multiple="true()"
                                    placeResponseDocument="true()"
                                    ref="instance('data-instance')/companyData" value="idega:resolveBeanProperties('aquaCultureService.getCompanyForCurrentUser()')"/>
                                    
                        <idega:setvalue
                                    ref="instance('data-instance')/reportForTheYear" value="idega:resolveExpression('aquaCultureService.getReportForTheYear()')"/>
                                    
                        <idega:setvalue
                            ref="instance('fbc_9_lds')/localizedEntries[@lang=instance('localized_strings')/current_language]/item" value="idega:resolveExpression('aquaCultureService.getFarms()')"/>

<!--                            
                        <idega:setvalue
                            ref="instance('fbc_13_lds')/localizedEntries[@lang=instance('localized_strings')/current_language]/item" value="idega:resolveExpression('aquaCultureService.getSpeciesGroups()')"/>
 -->
                    </xf:action>
                    
                
            </xf:action>
            <xf:instance id="fbc_9_lds" xmlns="">
                <local_src>
                    <localizedEntries lang="en">
                        <item>
                            <itemLabel/>
                            <itemValue/>
                        </item>
                    </localizedEntries>
                    <localizedEntries lang="is_IS">
                        <item>
                            <itemLabel/>
                            <itemValue/>
                        </item>
                    </localizedEntries>
                </local_src>
            </xf:instance>
            
        </xf:model>
        <xs:schema id="fb-schema">
        </xs:schema>
    </head>
    <body>
        <xf:group appearance="full">
            <xf:group bind="errorsGroup" class="xformErrors">
                <xf:repeat bind="errors">
                    <xf:output ref="."/>
                </xf:repeat>
            </xf:group>
            <idega:setError ev:event="idega-validation-error"
                id="formSetErrorHandler" ref="instance('error-instance')/error"/>
            <idega:switch>
                <idega:case id="fbc_1" show="instance('control-instance')/generatePdf='true'">
                    <xf:group appearance="full">
                    
                        <xf:output bind="fbc_5_bind" id="fbc_5" type="fbc_text_output">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_5-label[@lang=instance('localized_strings')/current_language]"/>
                        </xf:output>
                        <xf:output bind="fbc_6_bind" id="fbc_6" type="fbc_text_output">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_6-label[@lang=instance('localized_strings')/current_language]"/>
                        </xf:output>
                        <xf:output bind="fbc_7_bind" id="fbc_7" type="fbc_text_output">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_7-label[@lang=instance('localized_strings')/current_language]"/>
                        </xf:output>
                        
                        <xf:output bind="fbc_8_bind" id="fbc_8" type="fbc_text_output">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_8-label[@lang=instance('localized_strings')/current_language]"/>
                        </xf:output>
                        
                        <xf:select1 appearance="minimal"
                            bind="fbc_9_bind" id="fbc_9" type="fbc_single_select_minimal">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_9-label[@lang=instance('localized_strings')/current_language]"/>
                            <xf:itemset model="data_model" nodeset="instance('fbc_9_lds')/localizedEntries[@lang=instance('localized_strings')/current_language]/item">
                                <xf:label ref="itemLabel"/>
                                <xf:value ref="itemValue"/>
                            </xf:itemset>
                            <xf:dispatch ev:event="idega-xforms-ready"
                                name="idega-validate" target="fbc_9"/>
                            <xf:dispatch ev:event="xforms-value-changed"
                                name="idega-validate" target="fbc_9"/>
                                
                            <idega:validator ev:event="idega-validate">
                                <idega:message errorType="required"
                                    model="data_model" value="instance('localized_strings')/fbc_9-required[@lang=instance('localized_strings')/current_language]"/>
                            </idega:validator>
                            <xf:alert ref="instance('error-instance')/error[@for='fbc_9']"/>
                        </xf:select1>
                        
                        <!-- farm structure -->
                        <xf:group appereance="full" id="fbc_10">
                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_10-label[@lang=instance('localized_strings')/current_language]"/>
                              
                             <xf:dispatch ev:event="xforms-value-changed" name="idega-validate" target="fbc_10"/>
                           
                            <idega:validator componentId="fbc_10" ev:event="idega-validate" validateif="string(sum(instance('data-instance')/farmStructure/list/row/cost_estimate)) !='NaN'">
                                <idega:message errorType="custom" model="data_model" value="instance('localized_strings')/fbc_10-table-count-error[@lang=instance('localized_strings')/current_language]"/>
                            </idega:validator> 
                            
                            <xf:trigger class="insertRowButton farmStructure" bind="fbc_10_trigger" id="fbc_11">
                                <xf:label model="data_model" ref="instance('localized_strings')/fbc_10-insert-label[@lang=instance('localized_strings')/current_language]"/>
                                <xf:action>
                                    <xf:insert at="last()" nodeset="../list/row" position="after"/>
                                </xf:action>
                            </xf:trigger>
                            <xf:trigger bind="fbc_10_trigger" id="fbc_12">
                                <xf:label model="data_model" ref="instance('localized_strings')/fbc_10-delete-label[@lang=instance('localized_strings')/current_language]"/>
                                <xf:action>
                                    <xf:delete at="last()-1" nodeset="../list/row"/>
                                </xf:action>
                            </xf:trigger>
                            <xf:repeat class="farmStructure" appearance="compact" bind="fbc_10_bind" id="fbc_10_repeat_id">
                            
                                <xf:input ref="./speciesGroup" class="substitute speciesGroup">
                                    <xf:label model="data_model" ref="instance('localized_strings')/fbc_10-col1-label[@lang=instance('localized_strings')/current_language]"/>
                                </xf:input>

<!-- 
                                <xf:select1 appearance="minimal"
                                ref="./speciesGroup"
		                             type="fbc_single_select_minimal">
		                            <xf:label model="data_model" ref="instance('localized_strings')/fbc_10-col1-label[@lang=instance('localized_strings')/current_language]"/>
		                            <xf:item>
				                        <xf:label>Fiskur</xf:label>
				                        <xf:value>fiskur</xf:value>
                                    </xf:item>
                                    <xf:item>
                                        <xf:label>Lindýr</xf:label>
                                        <xf:value>lindyr</xf:value>
                                    </xf:item>
		                        </xf:select1>
-->
		                        
                            
                                <xf:input ref="./size">
                                    <xf:label model="data_model" ref="instance('localized_strings')/fbc_10-col4-label[@lang=instance('localized_strings')/current_language]"/>
                                </xf:input>
                            </xf:repeat>
                            <!-- 
                            <xf:output class="total" value="format-number(sum(table_fbc_38/list/row/cost_estimate), '###.###,##', 'european')">
                                <xf:label model="data_model" ref="instance('localized_strings')/table_1-total-label[@lang=instance('localized_strings')/current_language]"/>
                            </xf:output>
                             -->
                             <xf:alert ref="instance('error-instance')/error[@for='fbc_10']"/>
                        
                        </xf:group>
                    
                        <div class="fbc_button_area" id="fbc_2" type="fbc_button_area">
                            <xf:trigger bind="bind-submissionButton"
                                class="fbc_button_submit" id="fbc_3" type="fbc_button_submit">
                                <xf:label model="data_model" ref="instance('localized_strings')/page-1-submit_button-label[@lang=instance('localized_strings')/current_language]"/>
                                <xf:action ev:event="DOMActivate">
                                    <xf:setvalue
                                    ref="instance('control-instance')/submission" value="'true'"/>
                                    <idega:dispatch
                                    name="idega-validate" target="//h:body//*[starts-with(@id, 'fbc_')]"/>
                                    <xf:dispatch name="xforms-rebuild" target="data_model"/>
                                    <xf:dispatch
                                    name="xforms-recalculate" target="data_model"/>
                                    <xf:dispatch
                                    name="xforms-revalidate" target="data_model"/>
                                    <xf:dispatch name="xforms-refresh" target="data_model"/>
                                    <xf:action if="count-non-empty(instance('error-instance')/error)=0">
                                    <xf:send submission="submit_data_submission"/>
                                    </xf:action>
                                    <xf:dispatch
                                    if="count-non-empty(instance('error-instance')/error)!=0"
                                    name="idega-submit-error" target="idega-submission-error"/>
                                </xf:action>
                            </xf:trigger>
                        </div>
                    </xf:group>
                </idega:case>
                <idega:case id="fbc_4" type="thx_page">
                    <xf:group appearance="full" class="thx_page">
                        <xf:label model="data_model" ref="instance('localized_strings')/page-2-label[@lang=instance('localized_strings')/current_language]"/>
                        <xf:output model="data_model" ref="instance('localized_strings')/submission-success_message[@lang=instance('localized_strings')/current_language]"/>
                    </xf:group>
                </idega:case>
            </idega:switch>
        </xf:group>
    </body>
</html>
